# Copilot Instructions

- **Architecture**: .NET 9 isolated Azure Functions app. Entry wiring in src/XtremeIdiots.Portal.Events.Ingest.App.V1/Program.cs registers Application Insights, the repository API client, Service Bus client factory, memory cache, and health checks.
- **HTTP ingress**: src/XtremeIdiots.Portal.Events.Ingest.App.V1/Functions/V1/PlayerEvents.cs and ServerEvents.cs expose /v1/OnPlayerConnected, /v1/OnChatMessage, /v1/OnMapVote, /v1/OnServerConnected, /v1/OnMapChange (anonymous). Each deserializes DTOs and enqueues to player_connected_queue, chat_message_queue, map_vote_queue, server_connected_queue, map_change_queue.
- **Queue processors**: PlayerEventsIngest.cs and ServerEventsIngest.cs consume those queues, validate payloads, fetch/update players/maps via the Portal Repository API, cache player IDs with IMemoryCache, and emit EventTelemetry for key events.
- **Dead-letter replay**: ReprocessDeadLetterQueue.cs (Function auth) replays DLQ messages for a given queueName via /api/v1/ReprocessDeadLetterQueue; it sends messages back to the active queue using SubQueue.DeadLetter and completes originals.
- **Contracts/OpenAPI**: Shared DTOs live in XtremeIdiots.Portal.Events.Abstractions.V1/Models/V1; HTTP surface is mirrored in openapi/openapi-v1.json (see EventIngest.openapi+json.json for source snapshot).
- **Service Bus abstraction**: Use IServiceBusClientFactory/IServiceBusSender/IServiceBusReceiver wrappers; await using senders/receivers is required to dispose connections and keep functions testable.
- **Telemetry**: TelemetryInitializer sets cloud role name; host.json configures sampling with exceptions excluded. Prefer EventTelemetry for domain actions and leave dependency telemetry to SDK defaults.
- **Configuration**: local.settings.json defaults to Azurite + Service Bus emulator (sb://localhost:10002/, entity path events). Required: RepositoryApi:BaseUrl, RepositoryApi:ApplicationAudience, ServiceBusConnection:fullyQualifiedNamespace. Optional: ServiceBusConnection:ManagedIdentityClientId/AZURE_CLIENT_ID for MI auth, ApplicationInsights keys for live telemetry.
- **Local dev loop**: dotnet clean src/XtremeIdiots.Portal.Events.Ingest.App.V1/XtremeIdiots.Portal.Events.Ingest.App.V1.csproj && dotnet build src/XtremeIdiots.Portal.Events.Ingest.App.V1/XtremeIdiots.Portal.Events.Ingest.App.V1.csproj && dotnet test src --filter "FullyQualifiedName!~IntegrationTests".
- **Testing**: Unit tests in src/XtremeIdiots.Portal.Events.Ingest.App.V1.Tests (xUnit + Moq); focus on Service Bus wrappersâ€”inject IServiceBusClientFactory instead of new ServiceBusClient.
- **CI/CD workflows**: build-and-test on feature/bugfix/hotfix pushes; pr-verify on PRs (dev TF plan by default, skips dependabot/copilot/* unless labeled run-dev-plan; prd plan gated by run-prd-plan); deploy-prd on main + weekly schedule (build, apply TF, deploy Dev then Prd); deploy-dev manual; codequality weekly + PR/main; copilot-setup-steps validates workflow changes; destroy-development/environment handle teardown.
- **Reusable actions**: Workflows rely on composites from frasermolyneux/actions (dotnet-func-ci, terraform-plan, terraform-plan-and-apply, deploy-function-app).
- **Terraform**: terraform/ contains dev/prd tfvars and backend configs; pulls remote state from platform-workloads, platform-monitoring, portal-environments, portal-core; provisions Function App, Service Bus namespace/queues, APIM artifacts, dashboards, alerts, identities. Concurrency groups serialize Dev/Prd applies.
- **Operational notes**: Queue names must stay in sync across producers/consumers; health endpoint uses HealthCheckService with warning-level logging; prefer managed identity over connection strings.
- **References**: docs/development-workflows.md for branch/CI rules; src/XtremeIdiots.Portal.Events.Ingest.App.V1/Functions/V1 for endpoints/processors; terraform/ for infra definitions.

If any workflow or config nuance is unclear, call it out and we can extend these notes.
